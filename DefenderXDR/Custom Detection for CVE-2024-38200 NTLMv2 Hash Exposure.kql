// Custom Detection for CVE-2024-38200 NTLMv2 Hash Exposure ðŸŽ«

// https://github.com/passtheticket/CVE-2024-38200

// CVE-2024-38200 is a high-severity spoofing vulnerability in Microsoft Office. This flaw allows attackers to exploit a weakness in Microsoft Office, potentially exposing sensitive information such as NTLM hashes (NTLMv2) to unauthorized actors. The vulnerability affects multiple versions of Microsoft Office, including Office 2016, Office 2019, and the Office Long Term Servicing Channel (LTSC) 2021. It was discovered by Metin Yunus Kandemir (passtheticket), and the proof of concept (POC) and details are shared below.
// Although the vulnerability was addressed in the August 2024 security updates for Microsoft Office, organizations without automated patching solutions may still be exposed. If you use Microsoft Defender for Office 365, you can create a custom detection on DefenderXDR to identify potential abuse of this vulnerability. I have shared the KQL for this detection on my GitHub.

let OfficeURIs = dynamic(["ms-word:", "ms-powerpoint:", "ms-excel:", "ms-visio:", "ms-access:", "ms-project:", "ms-publisher:", "ms-spd:", "ms-infopath:"]);
let OfficeURICommands = dynamic(["ofv", "ofe"]);
UrlClickEvents
| where ActionType == @"ClickAllowed"
| where UrlChain has_any (OfficeURIs) and UrlChain has_any (OfficeURICommands)
| project Timestamp, ReportId, AccountUpn, IPAddress,  Workload, UrlChain

// MITRE ATT&CK
// Technique: User Execution (T1204)
// Sub-technique: Malicious File (T1204.002)
// Technique: Application Layer Protocol (T1071)
// Sub-technique: Web Protocols (T1071.001)
