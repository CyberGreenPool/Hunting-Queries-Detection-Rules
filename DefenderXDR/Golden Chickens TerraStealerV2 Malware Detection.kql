// https://www.recordedfuture.com/research/terrastealerv2-and-terralogger

// ðŸ¤£ Golden Chickens ðŸ¤£ 
// TerraStealerV2 Malware Detection
//
let QueryPeriod = 1d;
let MonitorExtension = dynamic([".lnk", ".exe", ".dll", ".msi"]);
let EPwithLowFP =
DeviceFileEvents
| where Timestamp > ago(QueryPeriod)
| where ActionType == @"FileCreated"
| where FileName has_any (MonitorExtension)
| invoke FileProfile("SHA1", 500) 
| where GlobalPrevalence < 5
| distinct DeviceName;
DeviceNetworkEvents
| where Timestamp > ago(QueryPeriod)
| where ActionType == "HttpConnectionInspected"
| where parse_json(AdditionalFields)["uri"] has "wetransfers.io/v.php" and 
parse_json(AdditionalFields)["uri"] has ".ocx"
| where DeviceName has_any (EPwithLowFP)
